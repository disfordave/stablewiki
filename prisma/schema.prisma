generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String             @id @default(cuid())
  email             String?            @unique
  username          String             @unique
  password          String
  recoverKey        String?            @unique
  name              String?
  avatarUrl         String?
  role              Role               @default(USER)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  comments          Comment[]
  pages             Page[]             @relation("PageAuthors")
  revisions         Revision[]
  status            Int                @default(0) // 0: Active, 1: Banned, 2: Suspended
  bannedUntil       DateTime?
  banReason         String?
  totalTrustCredits Int                @default(0)
  trustCredit       TrustCredit[]
  reactions         Reaction[]
  negativeReactions NegativeReaction[]
  isHidden          Boolean            @default(false)
}

model Page {
  id          String     @id @default(cuid())
  title       String
  slug        String     @unique
  content     String
  authorId    String?
  parentId    String?
  isPublished Boolean    @default(false)
  publishedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  isMedia     Boolean    @default(false)
  isRedirect  Boolean    @default(false)
  comments    Comment[]
  author      User?      @relation("PageAuthors", fields: [authorId], references: [id], onDelete: SetNull)
  parent      Page?      @relation("SubPages", fields: [parentId], references: [id], onDelete: SetNull)
  children    Page[]     @relation("SubPages")
  tags        PageTag[]
  revisions   Revision[]
  accessLevel Int        @default(0) // 0: Public, 1: Registered Users+, 2: Editors+, 9: Admins Only
  license     Int        @default(0) // 0: All Rights Reserved, 1: Creative Commons, etc.
  licenseText String     @default("")
  isHidden    Boolean    @default(false) // For hiding pages from search and listings
  isTemplate  Boolean    @default(false)
  ageRating   Int        @default(0) // 0, 13, 18 

  @@index([authorId])
}

model Revision {
  id                 String   @id @default(cuid())
  version            Int      @default(1)
  pageId             String
  authorId           String?
  content            String
  summary            String?
  createdAt          DateTime @default(now())
  isRedirect         Boolean  @default(false)
  redirectTargetSlug String?
  author             User?    @relation(fields: [authorId], references: [id], onDelete: SetNull)
  page               Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  title              String   @default("")

  @@index([pageId])
}

model Comment {
  id                String             @id @default(cuid())
  title             String
  pageId            String
  authorId          String?
  content           String
  rootCommentId     String?
  parentId          String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt // Automatically updates on modification
  author            User?              @relation(fields: [authorId], references: [id], onDelete: SetNull)
  page              Page               @relation(fields: [pageId], references: [id], onDelete: Cascade)
  root              Comment?           @relation("RootComments", fields: [rootCommentId], references: [id], onDelete: SetNull)
  rootReplies       Comment[]          @relation("RootComments")
  parent            Comment?           @relation("ThreadedComments", fields: [parentId], references: [id], onDelete: SetNull)
  replies           Comment[]          @relation("ThreadedComments")
  reactions         Reaction[]
  negativeReactions NegativeReaction[]
  tags              CommentTag[]
  deleted           Boolean            @default(false)
  isHidden          Boolean            @default(false)

  @@index([pageId, authorId])
}

model Tag {
  id          String       @id @default(cuid())
  name        String       @unique
  description String?
  createdAt   DateTime     @default(now())
  pages       PageTag[]
  comments    CommentTag[]
}

model PageTag {
  pageId String
  tagId  String
  page   Page   @relation(fields: [pageId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([pageId, tagId])
}

model CommentTag {
  commentId String
  tagId     String
  comment   Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([commentId, tagId])
}

model TrustCredit {
  id        String   @id @default(cuid())
  userId    String
  amount    Int      @default(0)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Reaction {
  id        String   @id @default(cuid())
  userId    String?
  commentId String
  type      Int // e.g., 1: Like, 2: Love, etc.
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId, type])
  @@index([userId, commentId])
}

model NegativeReaction {
  id        String   @id @default(cuid())
  userId    String?
  commentId String
  type      Int // e.g., 1: Dislike, 2: Offensive, etc.
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId, type])
  @@index([userId, commentId])
}

enum Role {
  ADMIN
  EDITOR
  MODERATOR
  USER
}
